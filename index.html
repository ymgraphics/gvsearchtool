<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Opportunity Search</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Spinner CSS */
    .spinner-border {
      width: 3rem;
      height: 3rem;
      border-width: 0.4em;
    }
  </style>
</head>

<body>

  <div class="container mt-5">
    <h1 class="text-center">Search Opportunities</h1>

    <form id="opportunityForm" class="mt-4">
      <!-- Committee Input -->
      <div class="mb-3">
        <label for="committeeName" class="form-label">Enter Committee Name</label>
        <input type="text" class="form-control" id="committeeName" placeholder="Enter committee (e.g., Indonesia)"
          required>
      </div>

      <button type="submit" class="btn btn-primary">Search Opportunities</button>
    </form>

    <!-- Loading Spinner -->
    <div id="loading" class="text-center mt-4" style="display: none;">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading results...</p>
    </div>

    <!-- Display Results -->
    <div id="results" class="mt-5">
      <h2 class="text-center">Results</h2>
      <ul id="opportunitiesList" class="list-group"></ul>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.getElementById('opportunityForm').addEventListener('submit', async function (event) {
      event.preventDefault();

      const committeeName = document.getElementById('committeeName').value;

      if (committeeName) {
        // Show loading spinner
        document.getElementById('loading').style.display = 'block';

        const opportunities = await fetchOpportunitiesForAllProjects(committeeName);

        // Hide loading spinner
        document.getElementById('loading').style.display = 'none';

        displayOpportunities(opportunities);
      }
    });

    // List of Project IDs
    const projectIds = [
      1302011, 1280513, 1280516, 1280520, 1285146, 1280523, 1280390,
      1280526, 1280515, 1280511, 1281160, 1280518, 1280519, 1280521,
      1285122, 1286012, 1286870, 1280522
    ];

    // Fetch Opportunities for All Projects by Iterating Over Project IDs
    async function fetchOpportunitiesForAllProjects(committeeName) {
      const committeeId = await fetchCommitteeId(committeeName);
      const allOpportunities = [];

      for (const projectId of projectIds) {
        const opportunities = await fetchOpportunitiesByProject(committeeId, projectId);
        allOpportunities.push(...opportunities); // Combine all opportunities
      }

      return allOpportunities;
    }

    // Fetch Opportunities by Project ID
    async function fetchOpportunitiesByProject(committeeId, projectId) {
      const query = getOpportunitiesQuery(committeeId, projectId);

      const response = await fetch("https://gis-api.aiesec.org/graphql", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `797149ff3e2ee6a8abc4f101a77c714caf9463dcb69be8bd5d53e0698064aa91`,
        },
        body: JSON.stringify({ query }),
      });

      const data = await response.json();
      return data.data.allOpportunity.data;
    }

    // Construct the GraphQL Query for a Single Project ID
    function getOpportunitiesQuery(committeeId, projectId) {
      return `
        query GetAllOpportunitiesQuery {
          allOpportunity: opportunities(
            filters: {
              programmes: [7],
              committee: ${committeeId},
              project_id: ${projectId}
            }
          ) {
            data {
              id
              description
              project_name
              project_description
              host_lc {
                name
              }
              home_mc {
                name
              }
              project {
                project_name
              }
              slots {
                start_date
                end_date
              }
            }
          }
        }
      `;
    }

    // Fetch Committee ID Based on Inputted Name
    async function fetchCommitteeId(committeeName) {
      const query = `
        query {
          committeeAutocomplete(q: "${committeeName}", tag:"MC") {
            id
            name
          }
        }
      `;

      const response = await fetch("https://gis-api.aiesec.org/graphql", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `797149ff3e2ee6a8abc4f101a77c714caf9463dcb69be8bd5d53e0698064aa91`,
        },
        body: JSON.stringify({ query }),
      });

      const data = await response.json();
      return data.data.committeeAutocomplete[0]?.id;
    }

    // Display Opportunities in the Results Section
    function displayOpportunities(opportunities) {
      const opportunitiesList = document.getElementById('opportunitiesList');
      opportunitiesList.innerHTML = '';

      if (opportunities.length === 0) {
        opportunitiesList.innerHTML = '<li class="list-group-item">No opportunities found.</li>';
      } else {
        opportunities.forEach(opportunity => {
          // Construct Slot Information
          const slotDetails = opportunity.slots.length > 0
            ? opportunity.slots.map(slot => `From ${slot.start_date} to ${slot.end_date}`).join('<br>')
            : 'No slots available';

          const listItem = `
            <li class="list-group-item">
              <h3 class="text-primary">${opportunity.project.project_name}</h3>
              <p>${opportunity.description}</p>
              <p><strong>Project Description:</strong> ${opportunity.project_description}</p>
              <p><strong>Host LC:</strong> ${opportunity.host_lc.name}</p>
              <p><strong>Home MC:</strong> ${opportunity.home_mc.name}</p>
              <p><strong>Slots:</strong><br>${slotDetails}</p>
              <a href="https://aiesec.org/opportunity/global-volunteer/${opportunity.id}" target="_blank" class="btn btn-outline-primary">
                View Opportunity
              </a>
            </li>
          `;
          opportunitiesList.innerHTML += listItem;
        });
      }
    }
  </script>
</body>

</html>
